<!DOCTYPE html>

<html>
    <head>
        <title id="title">finding file...</title>

        <link id="latex-style" rel="stylesheet" href="https://latex.vercel.app/style.css">
        <link rel="stylesheet" href="../webutil/style.css">

        <script type="text/javascript" src="../webutil/template.js"></script>
    </head>
    <body>
        <h1 id="js-warning">Please enable JavaScript to access files on this website</h1>
        <div id="content" style="display: none">
            <h3>Human test:</h3>
            <img src="./human_test.png" />
            <p>
                <b>Please type this in LaTeX as simply as you can:</b>
                <input id="pw"></input>
                <button onclick="submit()">Submit!</button>
            </p>
        </div>
        <script>
            $("#content").style.display = "block"
            

            var url = window.location.href
            var query = url.split("?")[1]

            query_file = null

            IV = null
            ciphertext = null
            padding = null

            if (query.indexOf("file=") == 0) {
                query_file = query.substring(5)

                $("#title").innerHTML = query_file

                // https://stackoverflow.com/questions/59215172/read-image-from-an-url-as-binary-string
                var xhttp = new XMLHttpRequest();
                xhttp.open('GET', SITE + "/CV/" + query_file, true);
                xhttp.responseType = 'arraybuffer';
                xhttp.onload = (event) => {
                    console.log(event)
                    
                    var byteArray = new Uint8Array(event.target.response);

                    //IV = byteArray.slice(0, 16)
                    //padding = byteArray[16]
                    //ciphertext = byteArray.slice(17).buffer
                    ciphertext = byteArray.buffer
                }
                xhttp.send()
                /*
                xhttp.send();
                xhttp.addEventListener('readystatechange', () => {
                    console.log(xhttp)
                    if (xhttp.readyState == 4) {
                        if (xhttp.status == 200) {
                            let reader = new FileReader();
                            //reader.readAsDataURL(xhttp.response);
                            reader.onload = (event) => {
                                
                                ret = event.target.result
                                idx = ret.indexOf(",")

                                ct = ret.substring(idx + 1)
                                console.log(ct)

                                // https://stackoverflow.com/questions/21797299/how-can-i-convert-a-base64-string-to-arraybuffer
                                var uintArray = Base64Binary.decode(ct);  
                                var byteArray = Base64Binary.decodeArrayBuffer(ct); 

                                console.log(byteArray)
                            }
                        } else {
                            $("#content").innerHTML = "Could not find <b>" + query_file + "</b>, please make sure this is the correct file or try again later. Status: " + xhttp.status + ", ready state: " + xhttp.readyState
                        }
                    }
                });
                */
            }

            // https://stackoverflow.com/questions/6965107/converting-between-strings-and-arraybuffers
            function str2ab(str) {
                var buf = new ArrayBuffer(str.length*2); // 2 bytes for each char
                var bufView = new Uint16Array(buf);
                for (var i=0, strLen=str.length; i<strLen; i++) {
                    bufView[i] = str.charCodeAt(i);
                }
                return buf;
            }

            function submit() {
                key = $("#pw").value.replaceAll(" ", "")
                var encoder = new TextEncoder();
                // https://www.haikel-fazzani.eu.org/snippet/string-uint8array-conversion
                var uint8Array = encoder.encode(key);
                console.log(uint8Array)

                var ptenc = encoder.encode("teehee");

                console.log(ciphertext)

                window.crypto.subtle.importKey(
                    "raw",
                    uint8Array,
                    "AES-CBC",
                    false,
                    ["decrypt", "encrypt"]
                ).then(key_import => {
                    var xhttp = new XMLHttpRequest();
                    xhttp.open('GET', SITE + "/files/encrypted/" + query_file, true);
                    xhttp.responseType = 'arraybuffer';
                    xhttp.onload = (event) => {
                        console.log(event)
                        
                        var byteArray = new Uint8Array(event.target.response);

                        IV = byteArray.slice(0, 16)

                        inn = window.crypto.subtle.encrypt(
                            {name: "AES-CBC", iv: IV},
                            key_import,
                            ciphertext
                        ).then(ct => {
                            console.log(ct)
                            console.log(ciphertext)
                            console.log(IV)

                            const utf8Decoder = new TextDecoder()
                            console.log(utf8Decoder.decode(ct)) // Obst;Person;

                            /*
                            out = window.crypto.subtle.decrypt(
                                {
                                    name: "AES-CBC", iv: IV
                                },
                                key_import,
                                ciphertext
                            ).then(pt => {console.log(pt)})
                            */
                        })
                    }
                    xhttp.send()

                    console.log(key_import)
                    
                })
            }
        </script>
    </body>
</html>